# Tests

This directory contains tests that validate the LLM Observability instrumentation libraries.


## Architecture

The test framework we use is [pytest](https://docs.pytest.org/en/stable/). In order to run tests across the different
libraries, the common functionality is abstracted into language-specific HTTP servers that serve the different
features as endpoints (see Dockerfiles and server.{py,js,}). An HTTP client is used in test cases to query the
different servers. Data produced in the servers is routed to a test agent which receives and persists traces and MLObs
requests to be returned back to the test case.

## Installation

```bash
pip install -r requirements.txt

# if actively developing a library feature
ln -s /path/to/dd-trace-py test/dd-trace-py
ln -s /path/to/dd-trace-js test/dd-trace-js
```

## Format/Lint

```bash
ruff format
ruff check
```

## Java test server local setup

The test server is compiled at test time by the Dockerfile, but to make sure you can properly develop with the dependencies used, you should be able to run this once, and every time a new dependency is added, but not on ever server change:

```bash
./gradlew dependencies --configuration compileClasspath
```

or

```bash
./gradlew --refresh-dependencies resolveDependencies
```

## Running Tests

```bash
# run all the tests
pytest

# run all the tests in a file
pytest tests/test_sdk.py

# run a specific test
pytest -k test_sdk_

# run tests for a particular set of libraries
TEST_LIBS=nodejs pytest ...
TEST_LIBS=python,nodejs pytest ...
```

## Making Trace Structures for SDK Tests

Trace structures are used to inform each of the client servers about the structure of the trace that should be generated. In `test_sdk.py`, trace structures are specified as `TestLLMObsSpan` or `TestApmSpan` objects, with optional `TestAnnotation` objects.

- The `TestLLMObsSpan` object is used to specify the structure of the trace that should be generated by the LLM Observability SDK.
- The `TestApmSpan` object is used to specify the structure of the trace that should be generated by the Datadog APM SDK.
- `TestAnnotation` objects correspond to calls to `LLMObs.annotate`, or `span.annotateIO` (in the case of the Java LLM Observability SDK).

To construct a test span, refer to the following example, and the pydantic model definitions in `test/utils.py`:

```python
from test.utils import TestLLMObsSpan, TestApmSpan, TestAnnotation

test_span = TestLLMObsSpan(
    kind="workflow", # required field
    name="test_name", # optional - name of the span to generate
    children=[
      TestLLMObsSpan(kind="task"),
      TestApmSpan(name="test_name"), # name is required for apm spans
      [TestLLMObsSpan(kind="task"), TestApmSpan(name="test_name")], # children can be a list of spans that are run in parallel
    ],
    annotations=[
      TestAnnotation(input_data="hello", output_data="world"),
      TestAnnotation(input_data="hello", output_data="world", metadata={"hello": "world"}),
    ],
    annotate_after=True, # optional - whether to apply the `annotations` after the span is finished or during its execution
    export_span="explicit", # optional - oneof "explicit","implicit" - if this field is present, the span will be exported. explicit means the span will be specified directly in being exported, implicit means the SDK will determine the current span and export that. if not present, the span will not be exported.
)
```

## Troubleshooting

### Docker Objects Left Running

Sometimes if the test framework fails to exit cleanly then some docker containers may be left running. To clean them up:

```bash
docker ps  # list any running containers
docker kill <container_id>
```


```bash
docker network ls  # list any networks

# rm any networks prefixed with llmobs-test
docker network rm $(docker network ls --filter name=llmobs-test -q)
```


### `subprocess.CalledProcessError: Command '['/usr/local/bin/docker', 'network', 'rm', 'llmobs-test-...']' returned non-zero exit status 1.`

This likely means that a container wasn't shutdown during the test and so the network cannot be removed.

### General

Make sure you have the latest version of the test agent docker image.
```bash
docker pull ghcr.io/datadog/dd-apm-test-agent/ddapm-test-agent:latest
```

## LLM Observability Provider Proxy Server

### Usage

When creating an LLM client for tests, pass the following base URL suffixed with the provider name:

```bash
http://0.0.0.0:5000/{provider}
```

As an example, here's how you would create an OpenAI client in Python:

```python
import openai

client = openai.OpenAI(base_url="http://0.0.0.0:5000/openai")
```

#### Running the server locally

To run the server locally, you can use the following command:

```bash
python -m venv .venv
pip install -r requirements.txt
python app.py
```

#### Running the server in CI for SDK repositories

Currently not supported, but in the future, this server will be dockerized and an image can be run to point against for tests.

### Adding new cassettes

To add a new cassette for new providers or tests, run the server locally as described in [Running the server locally](#running-the-server-locally) and then run the tests, letting the server record the cassettes. Open a PR to this repository with the new cassettes to merge them.

### Publishing a new docker image

Unsupported currently.
